#!/usr/bin/env python3
"""
Two-way sync for Observable Desktop notebooks.

Watches for:
1. External file changes (Claude Code edits) -> reloads notebook
2. Observable Desktop saves (user edits in app) -> notifies/logs changes

Usage: obs-sync <notebook.html>
"""

import hashlib
import os
import subprocess
import sys
import time
from pathlib import Path


def get_file_hash(path: Path) -> str:
    """Get MD5 hash of file content"""
    return hashlib.md5(path.read_bytes()).hexdigest()


def reload_notebook(file_path: str):
    """Close and reopen notebook in Observable Desktop"""
    script = '''
    tell application "Observable Desktop" to activate
    delay 0.1
    tell application "System Events"
        tell process "Observable Desktop"
            keystroke "w" using command down
        end tell
    end tell
    '''
    subprocess.run(['osascript', '-e', script], capture_output=True)
    time.sleep(0.3)
    subprocess.run(['open', '-a', 'Observable Desktop', file_path], capture_output=True)


def notify(message: str):
    """Show notification"""
    subprocess.run([
        'osascript', '-e',
        f'display notification "{message}" with title "Observable Sync"'
    ], capture_output=True)


def main():
    if len(sys.argv) < 2:
        print("Usage: obs-sync <notebook.html>")
        sys.exit(1)

    file_path = Path(sys.argv[1]).resolve()

    if not file_path.exists():
        print(f"File not found: {file_path}")
        sys.exit(1)

    print(f"Syncing: {file_path}")
    print("Watching for changes (Ctrl+C to stop)")
    print("-" * 50)

    # Track our own writes vs external changes
    last_hash = get_file_hash(file_path)
    last_mtime = file_path.stat().st_mtime
    our_last_write_hash = None  # Hash of content we last wrote

    # Open initially
    subprocess.run(['open', '-a', 'Observable Desktop', str(file_path)], capture_output=True)

    try:
        while True:
            time.sleep(0.5)

            current_mtime = file_path.stat().st_mtime
            if current_mtime != last_mtime:
                current_hash = get_file_hash(file_path)

                if current_hash != last_hash:
                    last_mtime = current_mtime
                    last_hash = current_hash

                    # Determine if this was our write or Observable's
                    if our_last_write_hash and current_hash == our_last_write_hash:
                        # This was our write, reload Observable
                        print(f"{time.strftime('%H:%M:%S')} [CLI->App] Reloading notebook...")
                        reload_notebook(str(file_path))
                        our_last_write_hash = None
                    else:
                        # Observable saved changes
                        print(f"{time.strftime('%H:%M:%S')} [App->File] Observable saved changes")
                        notify("Notebook saved by Observable")

                        # Read and show what changed
                        # (In a more advanced version, we could diff the cells)

    except KeyboardInterrupt:
        print("\nSync stopped")


if __name__ == '__main__':
    main()
