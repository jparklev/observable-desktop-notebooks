#!/bin/bash
# Observable Desktop File Watcher
# Watches a notebook file and reopens it when changed

FILE="$1"

if [[ -z "$FILE" ]]; then
    echo "Usage: obs-watch <notebook.html>"
    exit 1
fi

if [[ ! -f "$FILE" ]]; then
    echo "File not found: $FILE"
    exit 1
fi

FULL_PATH="$(cd "$(dirname "$FILE")" && pwd)/$(basename "$FILE")"
echo "Watching: $FULL_PATH"
echo "Press Ctrl+C to stop"

# Get initial modification time
LAST_MOD=$(stat -f %m "$FULL_PATH")

# Open the file initially
open -a "Observable Desktop" "$FULL_PATH"

while true; do
    sleep 1

    # Check if file was modified
    CURRENT_MOD=$(stat -f %m "$FULL_PATH" 2>/dev/null)

    if [[ "$CURRENT_MOD" != "$LAST_MOD" ]]; then
        echo "$(date +%H:%M:%S) - File changed, reopening..."
        LAST_MOD="$CURRENT_MOD"

        # Close current window and reopen
        osascript << 'APPLESCRIPT'
tell application "Observable Desktop" to activate
delay 0.1
tell application "System Events"
    tell process "Observable Desktop"
        keystroke "w" using command down
    end tell
end tell
APPLESCRIPT

        sleep 0.3
        open -a "Observable Desktop" "$FULL_PATH"
    fi
done
